<div class="grid p-fluid">
    <div class="col-12 md:col-12">
        <div class="card">
            <p-toast key="tst"></p-toast>
            <h2>Lançamentos</h2>
            <h5>Aqui você pode gerenciar seus lançamentos!</h5>
            <br>
            <!-- Toolbar -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <div class="my-2 flex">
                        <button pButton pRipple label="Novo" icon="pi pi-plus" class="p-button-success mr-2"
                                routerLink="/create-releases"></button>
                        <button pButton pRipple label="Excluir" icon="pi pi-trash" class="p-button-danger"
                                (click)="showDialog('DELETE_SELECTED')"
                                [disabled]="!selectedReleases || !selectedReleases.length"></button>
                    </div>
                </ng-template>

                <ng-template pTemplate="right">
                    <p-fileUpload mode="basic" accept=".csv" [maxFileSize]="100000" label="Import"
                                  chooseLabel="Importar" class="mr-2 inline-block"></p-fileUpload>
                    <button pButton pRipple label="Exportar" icon="pi pi-upload" class="p-button-help"
                            (click)="dt.exportCSV()"></button>
                </ng-template>
            </p-toolbar>
            <!-- Toolbar -->

            <!-- Table -->
            <p-table #dt
                     [lazy]="true" (onLazyLoad)="loadReleases($event)" [totalRecords]="totalRecords" [value]="releases"
                     [columns]="cols" [globalFilterFields]="['description']" [rows]="rows" [paginator]="true"
                     [rowsPerPageOptions]="[5,10,30,50]" [showCurrentPageReport]="true" [(selection)]="selectedReleases"
                     [rowHover]="true" selectionMode="multiple" responsiveLayout="scroll" dataKey="id"
                     currentPageReportTemplate="Mostrando {first} até {last} de {totalRecords} registros">
                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Editar lançamentos</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt.filterGlobal($event.target, 'contains')"
                                   placeholder="Procurar..." />
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th pSortableColumn="description">Descrição <p-sortIcon field="description"></p-sortIcon>
                        </th>
                        <th pSortableColumn="mouth">Mês <p-sortIcon field="mouth"></p-sortIcon>
                        </th>
                        <th>Transação</th>
                        <th pSortableColumn="year">Ano <p-sortIcon field="year"></p-sortIcon>
                        </th>
                        <th pSortableColumn="value">Valor <p-sortIcon field="value"></p-sortIcon>
                        </th>
                        <th pSortableColumn="type">Tipo <p-sortIcon field="type"></p-sortIcon>
                        </th>
                        <th pSortableColumn="status">Status <p-sortIcon field="status"></p-sortIcon>
                        </th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-release>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="release"></p-tableCheckbox>
                        </td>
                        <td style="width:20%; min-width:8rem;"><span class="p-column-title">Descrição</span>
                            {{release.description}}
                        </td>
                        <td style="width:10%; min-width:5rem;">
                            <span class="p-column-title">Mês</span>
                            {{release.mouth}}
                        </td>
                        <td style="width:10%; min-width:5rem;"><span class="p-column-title">Transação</span>
                            <div class="flex align-items-center justify-content-center border-round"
                                 [ngClass]="release.type === 'DESPESA' ? 'buy' : 'gain'"
                                 [ngStyle]="{ width: '3.5rem', height: '2.5rem' }">
                                <i
                                   [ngClass]="['pi text-xl text-white', release.type === 'DESPESA' ? 'pi-shopping-cart' : 'pi-dollar']"></i>
                            </div>
                        </td>
                        <td style="width:10%; min-width:8rem;">
                            <span class="p-column-title">Ano</span>
                            {{release.year}}
                        </td>
                        <td style="width:10%; min-width:5rem;">
                            <span class="p-column-title">Valor</span>
                            {{release.value | currency:'BRL'}}
                        </td>
                        <td style="width:10%; min-width: 5rem;">
                            <span class="p-column-title">Tipo</span>
                            {{release.type}}
                        </td>
                        <td style="width:10%; min-width: 5rem; max-width:8rem;"><span class="p-column-title">Status</span>
                            <span
                                  [ngClass]="['releases-badge', release.status === 'EFETIVADO' ? 'status-effective' : 'status-pending']">{{release.status}}</span>
                        </td>
                        <td style="width:10%;">
                            <div class="flex">
                                <button *ngIf="release.status === 'PENDENTE'" pButton pRipple pTooltip="Efetivar" icon="pi pi-check" class="p-button-rounded p-button-info mr-2" (click)="showDialog('EFFECTIVE', release)"></button>
                                <button *ngIf="release.status === 'PENDENTE'" pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2" (click)="editRelease(release)"></button>
                                <button *ngIf="release.status === 'EFETIVADO'" pButton pRipple pTooltip="Cancelar" icon="pi pi-times" class="p-button-rounded p-button-warning mr-2" (click)="showDialog('CANCEL', release)"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            <!-- Table -->
        </div>

        <!-- Dialogs -->
        <p-dialog [(visible)]="showEditDialog" [style]="{width: '450px'}" header="Detalhes" [modal]="true"
                  class="p-fluid">
            <ng-template pTemplate="content">
                <div class=" mt-0 mx-auto mb-5 block shadow-2 flex align-items-center justify-content-center border-round"
                     [ngClass]="release.type === 'DESPESA' ? 'buy' : 'gain'"
                     [ngStyle]="{ width: '3.5rem', height: '2.5rem' }">
                    <i
                       [ngClass]="['pi text-xl text-white', release.type === 'DESPESA' ? 'pi-shopping-cart' : 'pi-dollar']"></i>
                </div>
                <div class="field">
                    <label for="year">Ano</label>
                    <p-inputNumber id="year" [(ngModel)]="release.year" [required]="true" autofocus></p-inputNumber>
                    <small *ngIf="submitted && !release.year">Campo obrigatório</small>
                </div>
                <div class="field">
                    <label for="mouth">Mês</label>
                    <p-dropdown id="mouth" [options]="months" [(ngModel)]="release.mouth" placeholder="Selecione"
                                [required]="true" [showClear]="true"></p-dropdown>
                    <small *ngIf="submitted && !release.mouth">Campo obrigatório</small>
                </div>
                <div class="field">
                    <label for="description">Descrição</label>
                    <textarea id="description" pInputTextarea [(ngModel)]="release.description" required rows="3"
                              cols="20"></textarea>
                    <small *ngIf="submitted && !release.description">Campo obrigatório</small>
                </div>
                <div class="field">
                    <label for="releaseType">Tipo de Lançamento</label>
                    <p-dropdown id="releaseType" [options]="releaseType" [(ngModel)]="release.type"
                                placeholder="Selecione" [required]="true" [showClear]="true"></p-dropdown>
                    <small *ngIf="submitted && !release.type">Campo obrigatório</small>
                </div>
                <div class="field">
                    <label for="value">Valor</label>
                    <p-inputNumber id="value" [(ngModel)]="release.value" mode="currency" currency="BRL" locale="pt-BR">
                    </p-inputNumber>
                </div>
            </ng-template>

            <ng-template pTemplate="footer">
                <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
                        (click)="hideDialog()"></button>
                <button pButton pRipple label="Salvar" icon="pi pi-check" class="p-button-text"
                        (click)="saveRelease(release)"></button>
            </ng-template>
        </p-dialog>

        <p-dialog [(visible)]="showAlert" header="Confirmar" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span *ngIf="release && action ==='EFFECTIVE' || action ==='CANCEL'">
                    Você tem certeza que deseja <b>{{action === 'EFFECTIVE' ? 'efetivar' : 'cancelar'}}</b> o lançamento
                    <b>{{release.description.trim()}}</b>?
                </span>
                <span *ngIf="action === 'DELETE_SELECTED'">
                    Você tem certeza que quer excluir os lançamentos selecionados?
                </span>
            </div>
            <ng-template pTemplate="footer">
                <button pButton pRipple icon="pi pi-times" class="p-button-text" label="Não"
                        (click)="showAlert = false"></button>
                <button *ngIf="action === 'EFFECTIVE'" pButton pRipple icon="pi pi-check" class="p-button-text"
                        label="Sim" (click)="confirmEffectiveRelease()"></button>
                <button *ngIf="action === 'CANCEL'" pButton pRipple icon="pi pi-check" class="p-button-text" label="Sim"
                        (click)="confirmCancelRelease()"></button>
                <button *ngIf="action === 'DELETE_SELECTED'" pButton pRipple icon="pi pi-check" class="p-button-text"
                        label="Sim" (click)="confirmDeleteSelected()"></button>
            </ng-template>
        </p-dialog>
        <!-- Dialogs -->
    </div>
</div>